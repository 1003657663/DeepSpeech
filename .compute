#!/bin/bash

set -xe

# check HTTP_PROXY
if ! (( $( env | grep -iq "^http_proxy=" ) )); then
    source /etc/profile
fi

apt-get install -y python3-venv
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.0-rc2

# Install ds_ctcdecoder package from TaskCluster
pip install $(python3 util/taskcluster.py --decoder)
pip install pandas

mkdir -p ../keep/summaries

CV="${SHARED_DIR}/data/mozilla/CommonVoice/v2.0"

python -u DeepSpeech.py \
       --notest\
       --train_welsh "${CV}/cy/clips/train.csv"\
       --dev_welsh "${CV}/cy/clips/dev.csv"\
       --train_kyrgyz "${CV}/ky/clips/train.csv"\
       --dev_kyrgyz "${CV}/ky/clips/dev.csv"\
       --train_batch_size 24 \
       --dev_batch_size 48 \
       --test_batch_size 48 \
       --n_hidden 2048 \
       --learning_rate 0.0001 \
       --dropout_rate 0.2 \
       --epoch 13 \
       --display_step 0 \
       --validation_step 1 \
       --checkpoint_dir "../keep" \
       --summary_dir "../keep/summaries"
