#!/bin/bash

set -xe

sleep 60
apt-get install -y python3-venv
python3 -m venv /tmp/venv
source /tmp/venv/bin/activate

pip install -r <(grep -v tensorflow requirements.txt)
pip install tensorflow-gpu==1.13.1

# Install ds_ctcdecoder package from TaskCluster
pip install $(python3 util/taskcluster.py --decoder)

mkdir -p "../keep/summaries"
mkdir -p "/tmp/cached_feats"

data="${SHARED_DIR}/data"
grv="${data}/gramvaani/hindi"

python -u DeepSpeech.py \
  --noearly_stop \
  --train_files "${grv}/train.csv" \
  --dev_files "${grv}/dev.csv" \
  --test_files "${grv}/test.csv" \
  --train_batch_size 24 \
  --dev_batch_size 48 \
  --test_batch_size 48 \
  --n_hidden 2048 \
  --learning_rate 0.0001 \
  --dropout_rate 0.05 \
  --epochs 60 \
  --checkpoint_dir "../keep" \
  --summary_dir "../keep/summaries" \
  --feature_cache "/tmp/cached_feats"
